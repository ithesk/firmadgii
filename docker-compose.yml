version: '3.8'

services:
  dgii-microservice:
    build: .
    image: ${IMAGE_NAME:-dgii-ecf-microservice}:${IMAGE_TAG:-latest}
    container_name: ${CONTAINER_NAME:-dgii-ecf-microservice}
    ports:
      - "${HOST_PORT:-3000}:3000"
    environment:
      # Server Configuration
      PORT: 3000
      NODE_ENV: ${NODE_ENV:-production}
      LOG_LEVEL: ${LOG_LEVEL:-info}

      # DGII Configuration
      DGII_ENVIRONMENT: ${DGII_ENVIRONMENT:-cert}

      # Security
      API_KEY: ${API_KEY:-change_me_in_production}

      # Certificate Configuration
      # Option 1: Mount certificate file (use CERTIFICATE_PATH)
      CERTIFICATE_PATH: ${CERTIFICATE_PATH:-/app/certificates/certificado.p12}
      CERTIFICATE_PASSWORD: ${CERTIFICATE_PASSWORD}
      # Option 2: Use Base64 encoded certificate (for cloud deployments)
      CERTIFICATE_BASE64: ${CERTIFICATE_BASE64:-}

      # Receptor Configuration (for DGII Emisor-Receptor endpoints)
      RNC_RECEPTOR: ${RNC_RECEPTOR:-}

      # Odoo Integration (optional)
      ODOO_WEBHOOK_URL: ${ODOO_WEBHOOK_URL:-}
      ODOO_WEBHOOK_API_KEY: ${ODOO_WEBHOOK_API_KEY:-}
    volumes:
      # Mount certificates directory (read-only for security)
      - ${CERTIFICATES_PATH:-./certificates}:/app/certificates:ro
      # Mount logs directory for persistence
      - ${LOGS_PATH:-./logs}:/app/logs
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
